---
- name: Install LLM Worker: Mount EFS + Docker Setup
  hosts: all
  become: true
  vars:
    ansible_python_interpreter: /usr/bin/python3
    efs_ip: "172.32.1.143"
    share_path: "/share"
    llm_data: "/share/llm"
    llm_tmp: "/share/tmp"
    docker_compose_dir: "/opt/llm"

  tasks:
    - name: Update apt cache
      apt:
        update_cache: yes

    - name: Install necessary packages
      apt:
        name:
          - nfs-common
          - docker.io
          - curl
        state: present

    # --- EFS Setup ---
    - name: Create share directory
      file:
        path: "{{ share_path }}"
        state: directory
        owner: root
        group: root
        mode: '0755'

    - name: Check if NFS is already mounted
      shell: mount | grep -q '{{ efs_ip }}:/'
      register: nfs_mounted
      ignore_errors: true
      changed_when: false

    - name: Mount NFS if not mounted
      mount:
        src: "{{ efs_ip }}:/"
        path: "{{ share_path }}"
        fstype: nfs4
        opts: defaults,_netdev
        state: mounted
      when: nfs_mounted.rc != 0

    - name: Add mount entry to fstab
      lineinfile:
        path: /etc/fstab
        line: "{{ efs_ip }}:/ {{ share_path }} nfs4 defaults,_netdev 0 0"
        state: present

    # --- Docker Setup ---
    - name: Ensure Docker service is started and enabled
      systemd:
        name: docker
        state: started
        enabled: yes

    - name: Create Docker CLI plugin dir
      file:
        path: /usr/local/lib/docker/cli-plugins
        state: directory
        mode: '0755'

    - name: Download Docker Compose binary
      get_url:
        url: "https://github.com/docker/compose/releases/download/v2.3.3/docker-compose-linux-x86_64"
        dest: /usr/local/lib/docker/cli-plugins/docker-compose
        mode: '0755'

    - name: Create Docker Compose directory
      file:
        path: "{{ docker_compose_dir }}"
        state: directory
        mode: '0755'

    - name: Write docker-compose.yml
      copy:
        dest: "{{ docker_compose_dir }}/docker-compose.yml"
        mode: '0644'
        content: |
          version: "3.8"
          services:
            llm:
              image: ollama/ollama:latest
              container_name: llm
              restart: always
              ports:
                - "11434:11434"
              volumes:
                - {{ llm_data }}:/root/.ollama
                - {{ llm_tmp }}:/tmp
              environment:
                - OLLAMA_CONFIG=/var/lib/ollama/config.yaml

    - name: Run Docker Compose
      command: docker compose up -d
      args:
        chdir: "{{ docker_compose_dir }}"
